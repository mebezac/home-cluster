---
defaultPodOptions:
  terminationGracePeriodSeconds: 30
  securityContext:
    runAsUser: 568
    runAsGroup: 568
    fsGroup: 568
    fsGroupChangePolicy: "OnRootMismatch"

controllers:
  main:
    serviceAccount:
      name: tailscale
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      main:
        image:
          repository: dxflrs/garage
          tag: v2.2.0@sha256:45a61ce3f7c9c24fc23d9ed2b09b27ed560ab87b34605d175d5c588f539c24e4
        env:
          TZ: America/Detroit
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            memory: 512Mi
      tailscale:
        image:
          repository: ghcr.io/tailscale/tailscale
          tag: v1.94.2@sha256:95e528798bebe75f39b10e74e7051cf51188ee615934f232ba7ad06a3390ffa1
        securityContext:
          privileged: true
          runAsUser: 0
          runAsGroup: 0
        env:
          TS_KUBE_SECRET: "tailscale-auth"
          TS_USERSPACE: "false"
          TS_DEBUG_FIREWALL_MODE: "auto"
          POD_NAME:
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          POD_UID:
            valueFrom:
              fieldRef:
                fieldPath: metadata.uid
        envFrom:
          - secretRef:
              name: tailscale-secret
        resources:
          limits:
            squat.ai/tun: "1"
      rclone:
        image:
          repository: rclone/rclone
          tag: 1.73.1@sha256:c08f5e100e1c4fa4deb1315b56a47c0cc0e765222b7c0834bc93305f2e4d85c0
        command:
          - /bin/sh
          - -c
        args:
          - |
            if ! getent passwd 568 >/dev/null; then
              echo "appuser:x:568:568::/home/appuser:/sbin/nologin" >> /etc/passwd
              echo "appgroup:x:568:" >> /etc/group || true
              mkdir -p /home/appuser && chown 568:568 /home/appuser
            fi
            grep -q '^user_allow_other' /etc/fuse.conf || echo 'user_allow_other' >> /etc/fuse.conf
            exec su -s /bin/sh -c 'exec rclone mount bf-nd24-10tb-garage-crypt: /data --config /etc/rclone/rclone.conf --allow-other --allow-non-empty --vfs-cache-mode writes --vfs-cache-max-size 6G --vfs-cache-max-age 15m --cache-dir=/vfs-cache --log-level NOTICE --uid=568 --gid=568 --umask=002' appuser
        lifecycle:
          preStop:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  echo "PreStop: unmounting rclone fuse..."
                  # Try fusermount3 first, then fallback
                  fusermount3 -u /data 2>/dev/null || true
                  fusermount -u /data 2>/dev/null || true
                  umount -l /data 2>/dev/null || true
        envFrom:
          - secretRef:
              name: rclone-secret
        securityContext:
          privileged: true
          capabilities:
            add:
              - SYS_ADMIN
          runAsUser: 0
          runAsGroup: 0
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            memory: 1Gi
service:
  s3:
    controller: main
    ports:
      s3:
        port: 3900
  admin:
    controller: main
    ports:
      admin:
        port: 3903
  metrics:
    controller: main
    ports:
      metrics:
        port: 3903

ingress:
  main:
    enabled: true
    className: internal
    hosts:
      - host: garage.laboratory.casa
        paths:
          - path: /
            pathType: ImplementationSpecific
            service:
              identifier: s3
              port: s3

persistence:
  config:
    type: secret
    name: garage-secret
    globalMounts:
      - path: /etc/garage.toml
        subPath: garage.toml
  rclone-config:
    type: secret
    name: rclone-secret
    advancedMounts:
      main:
        rclone:
          - path: /etc/rclone/rclone.conf
            subPath: rclone.conf
            readOnly: true
  ssh-key:
    type: secret
    name: rclone-secret
    advancedMounts:
      main:
        rclone:
          - path: /etc/ssh-key/id_ed25519
            subPath: id_ed25519
            readOnly: true
  meta:
    enabled: true
    type: persistentVolumeClaim
    storageClass: longhorn
    accessMode: ReadWriteOnce
    size: 2Gi
    suffix: meta
    globalMounts:
      - path: /var/lib/garage/meta
  data:
    type: emptyDir
    advancedMounts:
      main:
        main:
          - path: /var/lib/garage/data
            mountPropagation: HostToContainer
        rclone:
          - path: /data
            mountPropagation: Bidirectional
  # Use this the first time, with an empty meta volume
  # and attach to the rclone container and:
  # cp /tmp-d/garage-marker /data/garage-marker
  # then comment this out again and re-deploy
  # tmpd:
  #   type: emptyDir
  #   advancedMounts:
  #     main:
  #       main:
  #         - path: /var/lib/garage/data
  #       rclone:
  #         - path: /tmp-d
  vfs-cache:
    enabled: true
    type: persistentVolumeClaim
    storageClass: openebs-hostpath
    accessMode: ReadWriteOnce
    suffix: vfs-cache
    size: 7Gi
    advancedMounts:
      main:
        rclone:
          - path: /vfs-cache

serviceMonitor:
  metrics:
    enabled: true
    serviceName: garage-metrics
    endpoints:
      - port: metrics
        scheme: http
        path: /metrics
        interval: 30s
        bearerTokenSecret:
          key: metrics_token
          name: garage-secret
