---
controllers:
  zigbee2mqtt:
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: ghcr.io/koenkk/zigbee2mqtt
          tag: 2.6.1@sha256:22e1fc160163edee0ceef47910211e97e7b0fb18b6bc94c9b799409252409f6a
        env:
          TZ: America/Detroit
          Z2M_WATCHDOG: default
          ZIGBEE2MQTT_DATA: /data
          ZIGBEE2MQTT_CONFIG_DEVICE_OPTIONS_RETAIN: "true"
          ZIGBEE2MQTT_CONFIG_PERMIT_JOIN: "false"
          ZIGBEE2MQTT_CONFIG_SERIAL_PORT: tcp://10.25.30.78:6638
          ZIGBEE2MQTT_CONFIG_MQTT_BASE_TOPIC: zigbee2mqtt
          ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER: zstack
          ZIGBEE2MQTT_CONFIG_SERIAL_BAUDRATE: 115200
          ZIGBEE2MQTT_CONFIG_MQTT_INCLUDE_DEVICE_INFORMATION: "true"
          ZIGBEE2MQTT_CONFIG_MQTT_KEEPALIVE: 60
          ZIGBEE2MQTT_CONFIG_MQTT_REJECT_UNAUTHORIZED: "true"
          ZIGBEE2MQTT_CONFIG_MQTT_SERVER: "mqtt://mqtt.laboratory.casa"
          ZIGBEE2MQTT_CONFIG_MQTT_VERSION: 5
          ZIGBEE2MQTT_CONFIG_FRONTEND_ENABLED: "true"
          ZIGBEE2MQTT_CONFIG_FRONTEND_PORT: &port 8080
          ZIGBEE2MQTT_CONFIG_FRONTEND_URL: https://zigbee2mqtt.laboratory.casa
          ZIGBEE2MQTT_CONFIG_ADVANCED_LOG_LEVEL: warning
          ZIGBEE2MQTT_CONFIG_ADVANCED_LOG_OUTPUT: '["console"]'
          ZIGBEE2MQTT_CONFIG_ADVANCED_CHANNEL: 25
          ZIGBEE2MQTT_CONFIG_ADVANCED_PAN_ID: 6755
          ZIGBEE2MQTT_CONFIG_ADVANCED_EXT_PAN_ID: "[221, 221, 221, 221, 221, 221, 221, 221]"
          ZIGBEE2MQTT_CONFIG_ADVANCED_LAST_SEEN: ISO_8601
          ZIGBEE2MQTT_CONFIG_AVAILABILITY_ACTIVE_TIMEOUT: 60
          ZIGBEE2MQTT_CONFIG_AVAILABILITY_PASSIVE_TIMEOUT: 2000
          ZIGBEE2MQTT_CONFIG_HOMEASSISTANT_ENABLED: "true"
          ZIGBEE2MQTT_CONFIG_HOMEASSISTANT_DISCOVERY_TOPIC: homeassistant
          ZIGBEE2MQTT_CONFIG_HOMEASSISTANT_STATUS_TOPIC: homeassistant/status
          ZIGBEE2MQTT_CONFIG_HOMEASSISTANT_EXPERIMENTAL_EVENT_ENTITIES: "true"
        envFrom:
          - secretRef:
              name: zigbee2mqtt-secret
        resources:
          requests:
            cpu: 10m
          limits:
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities: { drop: ["ALL"] }

defaultPodOptions:
  securityContext:
    runAsNonRoot: true
    runAsUser: 3000
    runAsGroup: 3000
    fsGroup: 3000
    fsGroupChangePolicy: OnRootMismatch

service:
  app:
    controller: zigbee2mqtt
    ports:
      http:
        port: *port

ingress:
  app:
    enabled: true
    className: internal
    hosts:
      - host: zigbee2mqtt.laboratory.casa
        paths:
          - path: /
            service:
              identifier: app
              port: http

persistence:
  data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: longhorn
    accessMode: ReadWriteOnce
    size: 256Mi
    globalMounts:
      - path: /data
