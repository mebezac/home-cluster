crds:
  enabled: true

fullnameOverride: victoria-metrics-stack

defaultDashboards:
  dashboards:
    node-exporter-full:
      enabled: false

# Enable Prometheus CRD conversion for smooth migration
victoria-metrics-operator:
  operator:
    disable_prometheus_converter: false
    enable_converter_ownership: true
  admissionWebhooks:
    policy: Ignore

# VMSingle - replaces Prometheus + Thanos
vmsingle:
  enabled: true
  spec:
    retentionPeriod: "30d"
    extraArgs:
      maxLabelsPerTimeseries: "120"
      search.maxConcurrentRequests: "4"
      search.maxMemoryPerQuery: "134217728"
      search.cacheTimestampOffset: 15m
    storage:
      storageClassName: longhorn-single-replica
      resources:
        requests:
          storage: 20Gi
    resources:
      requests:
        cpu: 100m
        memory: 1Gi
      limits:
        memory: 4Gi
  ingress:
    enabled: true
    ingressClassName: internal
    hosts:
      - vmsingle.laboratory.casa

# VMAgent - replaces Prometheus scraping + Alloy
vmagent:
  enabled: true
  spec:
    selectAllByDefault: true
    serviceScrapeSelector:
      matchExpressions:
        - key: release
          operator: NotIn
          values:
            - kube-prometheus-stack
    podScrapeSelector:
      matchExpressions:
        - key: release
          operator: NotIn
          values:
            - kube-prometheus-stack
    scrapeInterval: 30s
    externalLabels:
      cluster: home-cluster
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 512Mi

# VMAlert - replaces Prometheus alerting rules engine
vmalert:
  enabled: true
  spec:
    selectAllByDefault: false
    ruleSelector:
      matchExpressions:
        - key: app.kubernetes.io/instance
          operator: NotIn
          values:
            - kube-prometheus-stack
    evaluationInterval: 30s
    datasource:
      url: http://vmsingle-victoria-metrics-stack.observability.svc:8428
    remoteWrite:
      url: http://vmsingle-victoria-metrics-stack.observability.svc:8428/api/v1/write
    remoteRead:
      url: http://vmsingle-victoria-metrics-stack.observability.svc:8428/api/v1/read
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 256Mi

# VMAlertmanager - replaces AlertManager
alertmanager:
  enabled: true
  spec:
    replicaCount: 1
    configSecret: vmalertmanager-config
    secrets:
      - victoria-metrics-alertmanager-secret
    storage:
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          storageClassName: longhorn-single-replica
          resources:
            requests:
              storage: 1Gi
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 256Mi
  ingress:
    enabled: true
    ingressClassName: internal
    hosts:
      - alertmanager.laboratory.casa

# Exporters - enabled after kube-prometheus-stack removal
prometheus-node-exporter:
  enabled: true

kube-state-metrics:
  enabled: true

# Disable built-in Grafana, use existing
grafana:
  enabled: false

# Default scrape configs for K8s components
defaultRules:
  create: true
  groups:
    vmcluster:
      create: false
  rules:
    kubeScheduler: false
    kubeControllerManager: false
    kubeEtcd: true
    kubeProxy: false

kubeControllerManager:
  enabled: false

kubeScheduler:
  enabled: false

kubeEtcd:
  enabled: true
  endpoints:
    - 10.25.30.39
    - 10.25.30.45
    - 10.25.30.46
  service:
    port: 2381
    targetPort: 2381
  vmScrape:
    spec:
      endpoints:
        - port: http-metrics
          scheme: http

kubeApiServer:
  enabled: true
  vmScrape:
    spec:
      endpoints:
        - port: https
          metricRelabelConfigs:
            - action: drop
              sourceLabels: [__name__, le]
              regex: (apiserver_request|apiserver_request_sli|etcd_request)_duration_seconds_bucket;(0.15|0.25|0.3|0.35|0.4|0.45|0.6|0.7|0.8|0.9|1.25|1.5|1.75|2.5|3|3.5|4.5|6|7|8|9|15|25|30|50)
            - action: drop
              sourceLabels: [__name__, le]
              regex: apiserver_request_body_size_bytes_bucket;(150000|350000|550000|650000|850000|950000|(1\.15|1\.35|1\.55|1\.65|1\.85|1\.95|2\.15|2\.35|2\.55|2\.65|2\.85|2\.95)e\+06)
            - action: drop
              sourceLabels: [__name__]
              regex: (apiserver_response_sizes_bucket|apiserver_watch_cache_read_wait_seconds_bucket|apiserver_watch_list_duration_seconds_bucket)

kubelet:
  enabled: true
  vmScrapes:
    cadvisor:
      enabled: true
      spec:
        metricRelabelConfigs:
          - action: drop
            sourceLabels: [__name__]
            regex: (container_tasks_state|container_memory_failures_total)
  vmScrape:
    spec:
      interval: 30s
      metricRelabelConfigs:
        - action: labeldrop
          regex: (feature_node_kubernetes_io_.+|extensions_talos_dev_.+|gpu_.+|intel_feature_node_kubernetes_io_.+|beta_kubernetes_io_.+)
      relabelConfigs:
        - sourceLabels: [__meta_kubernetes_node_name]
          targetLabel: node
        - sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        - targetLabel: job
          replacement: kubelet
