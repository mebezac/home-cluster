defaultPodOptions:
  automountServiceAccountToken: false
  dnsConfig:
    options:
      - name: ndots
        value: '1'

controllers:
  main:
    annotations:
      reloader.stakater.com/auto: 'true'
    pod:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: 'OnRootMismatch'

    containers:
      gluetun:
        image:
          repository: ghcr.io/qdm12/gluetun
          tag: v3.42.0
        env:
          VPN_SERVICE_PROVIDER: windscribe
          VPN_TYPE: openvpn
          SERVER_REGIONS: ${WINDSCRIBE_REGION}
          FIREWALL: 'on'
          HTTPPROXY: 'on'
          HTTPPROXY_LISTENING_ADDRESS: ':8888'
          HTTPPROXY_STEALTH: 'on'
          HTTPPROXY_LOGIN: '${HTTPPROXY_USER}'
          HTTPPROXY_PASSWORD: '${HTTPPROXY_PASSWORD}'
        envFrom:
          - secretRef:
              name: gluetun-proxy-secret
        securityContext:
          capabilities:
            add:
              - NET_ADMIN

  ip-rotator:
    type: cronjob
    cronjob:
      schedule: "0 * * * *"
      successfulJobsHistory: 1
      failedJobsHistory: 1
    containers:
      rotate:
        image: ghcr.io/curlimages/curl:8.5.0
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Rotating IP..."
            curl -s -X PUT http://gluetun-proxy-main:8000/v1/openvpn/status -H "Content-Type: application/json" -d '{"status":"stopped"}'
            sleep 5
            curl -s -X PUT http://gluetun-proxy-main:8000/v1/openvpn/status -H "Content-Type: application/json" -d '{"status":"running"}'
            echo "IP rotation complete"
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          runAsNonRoot: true
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
        resources:
          requests:
            cpu: 10m
            memory: 16Mi
          limits:
            memory: 64Mi

service:
  gluetun:
    controller: main
    ports:
      http:
        port: 8888

ingress:
  gluetun:
    enabled: true
    className: internal
    hosts:
      - host: gluetun-proxy.laboratory.casa
        paths:
          - path: /
            service:
              identifier: gluetun
              port: http

persistence:
  config:
    type: emptyDir
