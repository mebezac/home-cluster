---
controllers:
  main:
    replicas: 1
    containers:
      main:
        image:
          repository: ghcr.io/immich-app/postgres
          tag: 16-vectorchord0.3.0-pgvectors0.3.0
        env:
          POSTGRES_INITDB_ARGS: --data-checksums
        envFrom:
          - secretRef:
              name: immich-db-secret
        resources:
          requests:
            cpu: 1000m
            memory: 250Mi
          limits:
            memory: 2Gi

      db18:
        image:
          repository: ghcr.io/immich-app/postgres
          tag: 18-vectorchord0.5.3-pgvector0.8.1@sha256:7d36e5fab4651a195afc5274f35ef6207d37340d9343c175165d0a056592f505
        env:
          POSTGRES_INITDB_ARGS: --data-checksums
          PGDATA: /var/lib/postgresql18/data
          PGPORT: 5433
        envFrom:
          - secretRef:
              name: immich-db-secret
        resources:
          requests:
            cpu: 1000m
            memory: 250Mi
          limits:
            memory: 2Gi

      metrics:
        image:
          repository: quay.io/prometheuscommunity/postgres-exporter
          tag: v0.19.0@sha256:e8a170b85eab07c75c2b0f3aa2806be5c2fe5bba46fd0336914e1f36572cde08
        env:
          DATA_SOURCE_URI: localhost:5432/postgres?sslmode=disable
        envFrom:
          - secretRef:
              name: immich-db-secret
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            memory: 256Mi
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
service:
  main:
    ports:
      postgres:
        port: 5432
  db18:
    ports:
      postgres:
        port: 5433
  metrics:
    ports:
      metrics:
        port: 9187

serviceMonitor:
  main:
    enabled: true
    serviceName: immich-db-metrics
    endpoints:
      - port: metrics

persistence:
  data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: longhorn
    accessMode: ReadWriteOnce
    suffix: data
    size: 5Gi
    advancedMounts:
      main:
        main:
          - path: /var/lib/postgresql/data
            subPath: postgresql-data
  data-18:
    enabled: true
    type: persistentVolumeClaim
    storageClass: longhorn
    accessMode: ReadWriteOnce
    suffix: data-18
    size: 5Gi
    advancedMounts:
      main:
        db18:
          - path: /var/lib/postgresql18/data
            subPath: postgresql-data
