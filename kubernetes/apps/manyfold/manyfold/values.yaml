controllers:
  manyfold:
    forceRename: manyfold
    annotations:
      secret.reloader.stakater.com/reload: manyfold-secret

    pod:
      securityContext:
        runAsUser: 3000
        runAsGroup: 3000
        fsGroup: 3000
        fsGroupChangePolicy: "OnRootMismatch"

    initContainers:
      chown-tmpdirs:
        image:
          repository: docker.io/library/alpine
          tag: "3.22"
          pullPolicy: IfNotPresent
        command:
          - /bin/sh
          - -c
        args:
          - |
            chmod o-rwx /tmp
        securityContext:
          runAsUser: 0
      init-db:
        image:
          repository: ghcr.io/home-operations/postgres-init
          tag: 17.6
          pullPolicy: IfNotPresent
        envFrom: &envFrom
          - secretRef:
              name: manyfold-secret
    containers:
      main:
        image:
          repository: ghcr.io/bjw-s-labs/manyfold
          tag: 0.120.0@sha256:95e7c3143877113a0c5fa103a5f45f3af24f572a9ccc9c5d2f4104657c380cdc
        env:
          DATABASE_ADAPTER: postgresql
          MULTIUSER: false
          PORT: &httpPort 3214
          REGISTRATION: false
        envFrom: &envFrom
          - secretRef:
              name: manyfold-secret
        probes:
          liveness: &probes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: *httpPort
              initialDelaySeconds: 0
              periodSeconds: 30
              timeoutSeconds: 1
              failureThreshold: 10
          readiness: *probes
        resources:
          requests:
            cpu: 20m
            memory: 128Mi
          limits:
            memory: 1024Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

service:
  app:
    forceRename: manyfold
    primary: true
    controller: manyfold
    ports:
      http:
        port: *httpPort

persistence:
  data:
    type: persistentVolumeClaim
    storageClass: longhorn
    accessMode: ReadWriteOnce
    suffix: data
    size: 1Gi
    advancedMounts:
      manyfold:
        main:
          - path: /data/libraries/main
            subPath: libraries/main
  tmpfs:
    type: emptyDir
    advancedMounts:
      manyfold:
        main: &tmpdirs
          - path: /tmp
            subPath: host-tmp
          - path: /app/tmp
            subPath: app-tmp
          - path: /app/log
            subPath: app-log
        chown-tmpdirs: *tmpdirs

ingress:
  app:
    enabled: true
    className: internal
    hosts:
      - host: manyfold.laboratory.casa
        paths:
          - path: /
            service:
              identifier: app
              port: http
